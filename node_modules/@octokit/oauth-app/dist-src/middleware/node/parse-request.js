// @ts-ignore remove once Node 10 is out maintenance. Replace with Object.fromEntries
import fromEntries from "fromentries";
export async function parseRequest(request) {
    const { searchParams } = new URL(request.url, "http://localhost");
    const query = fromEntries(searchParams);
    const headers = request.headers;
    if (!["POST", "PATCH"].includes(request.method)) {
        return { headers, query };
    }
    return new Promise((resolve, reject) => {
        let bodyChunks = [];
        request
            .on("error", reject)
            .on("data", (chunk) => bodyChunks.push(chunk))
            .on("end", async () => {
            const bodyString = Buffer.concat(bodyChunks).toString();
            if (!bodyString)
                return resolve({ headers, query });
            try {
                resolve({ headers, query, body: JSON.parse(bodyString) });
            }
            catch (error) {
                reject(error);
            }
        });
    });
}
